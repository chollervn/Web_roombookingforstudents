<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/admin_base::adminLayout(~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Đánh giá</title>
</head>
<body>
<section th:with="currentPage='reviews'">
    <style>
        .review-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .review-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #e3f2fd;
            color: #2196F3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }

        .user-details h5 {
            margin: 0;
            font-size: 15px;
            color: #2c3e50;
        }

        .review-date {
            font-size: 12px;
            color: #95a5a6;
        }

        .room-badge {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #7f8c8d;
            border: 1px solid #eee;
        }

        .rating-stars {
            color: #ffc107;
            margin-bottom: 10px;
        }

        .review-content {
            color: #34495e;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .owner-response {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #4CAF50;
            margin-top: 15px;
        }

        .response-header {
            font-size: 12px;
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .btn-respond {
            background: #e8f5e9;
            color: #4CAF50;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-respond:hover {
            background: #4CAF50;
            color: white;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: #7f8c8d;
        }
    </style>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Quản lý Đánh giá</h2>
                <p class="text-muted mb-0">Xem và phản hồi đánh giá từ khách thuê</p>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-value" th:text="${reviews.size()}">0</div>
                <div class="stat-label">Tổng đánh giá</div>
            </div>
            <div class="stat-box">
                <div class="stat-value text-warning">
                    <span th:if="${reviews.size() > 0}" 
                          th:text="${#numbers.formatDecimal(#aggregates.avg(reviews.![rating]), 1, 1)}">0.0</span>
                    <span th:unless="${reviews.size() > 0}">0.0</span>
                    <i class="fas fa-star" style="font-size: 16px;"></i>
                </div>
                <div class="stat-label">Điểm trung bình</div>
            </div>
            <div class="stat-box">
                <div class="stat-value text-success" 
                     th:text="${reviews.size() - #lists.size(reviews.?[response == null])}">0</div>
                <div class="stat-label">Đã phản hồi</div>
            </div>
            <div class="stat-box">
                <div class="stat-value text-danger" 
                     th:text="${#lists.size(reviews.?[response == null])}">0</div>
                <div class="stat-label">Chờ phản hồi</div>
            </div>
        </div>

        <!-- Reviews List -->
        <div class="row">
            <div class="col-12">
                <div th:if="${session.succMsg}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${session.succMsg}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <th:block th:text="${@commonUtil.removeSessionMessage()}"></th:block>
                </div>
                <div th:if="${session.errorMsg}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${session.errorMsg}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <th:block th:text="${@commonUtil.removeSessionMessage()}"></th:block>
                </div>

                <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-5 bg-white rounded-3">
                    <i class="far fa-comment-dots fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Chưa có đánh giá nào</p>
                </div>

                <div th:each="review : ${reviews}" class="review-card">
                    <div class="review-header">
                        <div class="user-info">
                            <div class="user-avatar" th:text="${#strings.substring(review.user.name, 0, 1)}">A</div>
                            <div class="user-details">
                                <h5 th:text="${review.user.name}">Nguyễn Văn A</h5>
                                <div class="review-date" th:text="${#temporals.format(review.reviewDate, 'dd/MM/yyyy HH:mm')}">01/01/2024</div>
                            </div>
                        </div>
                        <div class="room-badge">
                            <i class="fas fa-door-open me-1"></i>
                            <span th:text="${review.room.roomName}">Phòng 101</span>
                        </div>
                    </div>

                    <div class="rating-stars">
                        <i th:each="i : ${#numbers.sequence(1, 5)}" 
                           class="fas fa-star" 
                           th:classappend="${i <= review.rating} ? '' : 'text-muted'"
                           style="opacity: ${i <= review.rating} ? 1 : 0.3"></i>
                    </div>

                    <div class="review-content" th:text="${review.comment}">
                        Nội dung đánh giá...
                    </div>

                    <div th:if="${review.response}" class="owner-response">
                        <div class="response-header">
                            <span><i class="fas fa-reply me-1"></i> Phản hồi của bạn</span>
                            <button class="btn btn-sm btn-link p-0 text-success" 
                                    th:onclick="'openRespondModal(' + ${review.id} + ', `' + ${review.response} + '`)'">
                                Chỉnh sửa
                            </button>
                        </div>
                        <p class="mb-0" th:text="${review.response}">Nội dung phản hồi...</p>
                    </div>

                    <div th:unless="${review.response}" class="text-end">
                        <button class="btn-respond" th:onclick="'openRespondModal(' + ${review.id} + ', \'\')'">
                            <i class="fas fa-reply me-1"></i> Trả lời
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Respond Modal -->
    <div class="modal fade" id="respondModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Phản hồi đánh giá</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="respondForm" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nội dung phản hồi</label>
                            <textarea class="form-control" name="response" rows="4" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        <button type="submit" class="btn btn-primary">Gửi phản hồi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function openRespondModal(reviewId, currentResponse) {
            const modal = new bootstrap.Modal(document.getElementById('respondModal'));
            const form = document.getElementById('respondForm');
            const textarea = form.querySelector('textarea[name="response"]');
            
            form.action = '/admin/review/' + reviewId + '/respond';
            textarea.value = currentResponse || '';
            
            modal.show();
        }
    </script>
</section>
</body>
</html>
