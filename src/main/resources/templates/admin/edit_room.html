<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/admin_base::adminLayout(~{::section})}">

<head>
	<meta charset="UTF-8">
	<title>Chỉnh sửa phòng trọ</title>
</head>

<body>
	<section th:with="currentPage='rooms'">
		<style>
			.page-header {
				margin-bottom: 30px;
			}

			.page-header h2 {
				font-size: 28px;
				color: #2c3e50;
				margin-bottom: 10px;
			}

			.form-card {
				background: white;
				padding: 30px;
				border-radius: 12px;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
			}
		</style>

		<div class="page-header">
			<h2><i class="fas fa-edit"></i> Chỉnh sửa phòng trọ</h2>
		</div>

		<th:block th:if="${session.succMsg}">
			<div class="alert alert-success alert-dismissible fade show">
				[[${session.succMsg}]]
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
			<th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
		</th:block>

		<th:block th:if="${session.errorMsg}">
			<div class="alert alert-danger alert-dismissible fade show">
				[[${session.errorMsg}]]
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
			<th:block th:text="${@commonServiceImpl.removeSessionMessage()}"></th:block>
		</th:block>

		<div class="form-card">
			<form action="/admin/updateRoom" method="post" enctype="multipart/form-data">
				<input type="hidden" name="id" th:value="${room.id}">

				<div class="row">
					<!-- Thông tin cơ bản -->
					<div class="col-md-6">
						<div class="mb-3">
							<label class="form-label"><i class="fas fa-home"></i> Tên phòng trọ *</label>
							<input type="text" name="roomName" th:value="${room.roomName}" class="form-control"
								th:readonly="${not #lists.isEmpty(activeBookings)}" required>
						</div>

						<div class="mb-3">
							<label class="form-label"><i class="fas fa-list"></i> Loại phòng *</label>
							<input type="text" name="roomType" th:value="${room.roomType}" class="form-control"
								th:readonly="${not #lists.isEmpty(activeBookings)}" required>
						</div>

						<div class="mb-3">
							<label class="form-label"><i class="fas fa-money-bill-wave"></i> Giá thuê/tháng (VNĐ)
								*</label>
							<input type="number" name="monthlyRent" th:value="${room.monthlyRent}" class="form-control"
								min="0" required>
						</div>

						<div class="row">
							<div class="col-6">
								<div class="mb-3">
									<label class="form-label"><i class="fas fa-expand-arrows-alt"></i> Diện tích (m²)
										*</label>
									<input type="number" name="area" th:value="${room.area}" class="form-control"
										step="0.1" min="0" required>
								</div>
							</div>
							<div class="col-6">
								<div class="mb-3">
									<label class="form-label"><i class="fas fa-users"></i> Số người tối đa *</label>
									<input type="number" name="maxOccupants" th:value="${room.maxOccupants}"
										class="form-control" min="1" required>
								</div>
							</div>
						</div>
					</div>

					<!-- Địa chỉ và tiện ích -->
					<div class="col-md-6">
						<div class="mb-3">
							<label class="form-label"><i class="fas fa-map-marker-alt"></i> Địa chỉ *</label>
							<input type="text" name="address" th:value="${room.address}" class="form-control" required>
						</div>

						<div class="mb-3">
							<label class="form-label"><i class="fas fa-city"></i> Thành phố *</label>
							<select name="city" class="form-select" required>
								<option value="">-- Chọn thành phố --</option>
								<option value="Hà Nội" th:selected="${room.city == 'Hà Nội'}">Hà Nội</option>
								<option value="Hải Phòng" th:selected="${room.city == 'Hải Phòng'}">Hải Phòng</option>
								<option value="Thái Nguyên" th:selected="${room.city == 'Thái Nguyên'}">Thái Nguyên
								</option>
								<option value="Bắc Ninh" th:selected="${room.city == 'Bắc Ninh'}">Bắc Ninh</option>
								<option value="Vĩnh Phúc" th:selected="${room.city == 'Vĩnh Phúc'}">Vĩnh Phúc</option>
								<option value="Hưng Yên" th:selected="${room.city == 'Hưng Yên'}">Hưng Yên</option>
							</select>
						</div>

						<div class="row">
							<div class="col-12 mb-3">
								<label class="form-label"><i class="fas fa-map-marked-alt"></i> Vị trí trên bản
									đồ</label>
								<div class="input-group mb-2">
									<button type="button" class="btn btn-outline-primary" id="btnSearchMap">
										<i class="fas fa-search-location"></i> Tìm theo địa chỉ
									</button>
									<span class="input-group-text text-muted">hoặc click trực tiếp vào bản đồ</span>
								</div>
								<div id="map" style="height: 300px; border-radius: 8px; border: 1px solid #ced4da;">
								</div>
								<small class="text-muted">Kéo thả ghim hoặc click vào bản đồ để chọn vị trí chính
									xác.</small>
							</div>
							<div class="col-6">
								<div class="mb-3">
									<label class="form-label"><i class="fas fa-map-marker-alt"></i> Vĩ độ
										(Latitude)</label>
									<input type="number" name="latitude" id="latitude" th:value="${room.latitude}"
										class="form-control" placeholder="VD: 21.0285" step="0.000001" readonly>
								</div>
							</div>
							<div class="col-6">
								<div class="mb-3">
									<label class="form-label"><i class="fas fa-map-marker-alt"></i> Kinh độ
										(Longitude)</label>
									<input type="number" name="longitude" id="longitude" th:value="${room.longitude}"
										class="form-control" placeholder="VD: 105.8542" step="0.000001" readonly>
								</div>
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label"><i class="fas fa-image"></i> Ảnh phòng trọ</label>
							<input type="file" name="file" class="form-control" accept="image/*">
							<small class="text-muted">Để trống nếu không muốn thay đổi ảnh</small>
							<div class="mt-2" th:if="${room.image}">
								<img th:src="@{'/uploads/room_img/'+${room.image}}"
									style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label"><i class="fas fa-info-circle"></i> Mô tả</label>
							<textarea name="description" class="form-control" rows="3"
								th:text="${room.description}"></textarea>
						</div>
					</div>

					<!-- Trạng thái -->
					<div class="col-md-12">
						<hr>
						<h5 class="mb-3"><i class="fas fa-cog"></i> Trạng thái phòng</h5>
						<div class="row">
							<div class="col-md-6">
								<div class="form-check form-switch">
									<input class="form-check-input" type="checkbox" name="isActive"
										th:checked="${room.isActive}" id="isActive">
									<label class="form-check-label" for="isActive">
										<i class="fas fa-eye"></i> Hiển thị phòng trên trang web
									</label>
								</div>
							</div>
							<div class="col-md-6">
								<div class="form-check form-switch">
									<input class="form-check-input" type="checkbox" name="isAvailable"
										th:checked="${room.isAvailable}" id="isAvailable">
									<label class="form-check-label" for="isAvailable">
										<i class="fas fa-check-circle"></i> Phòng còn trống
										<a href="/admin/rooms" class="btn btn-secondary">
											<i class="fas fa-arrow-left"></i> Quay lại
										</a>
										<button type="submit" class="btn btn-primary">
											<i class="fas fa-save"></i> Cập nhật phòng trọ
										</button>
								</div>
							</div>
						</div>
			</form>

			<!-- Tenant Management (Moved outside main form) -->
			<div class="col-md-12 mt-4" th:if="${not #lists.isEmpty(activeBookings)}">
				<hr>
				<h5 class="mb-3"><i class="fas fa-users-cog"></i> Quản lý Người thuê & Hợp đồng</h5>
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle me-2"></i>
					<strong>Lưu ý:</strong> Phòng đang có người thuê. Các thông tin cấu trúc (Tên phòng, Loại
					phòng, Diện tích, Địa chỉ, Mô tả) không thể chỉnh sửa.
				</div>
				<div class="table-responsive">
					<table class="table table-bordered table-hover">
						<thead class="table-light">
							<tr>
								<th>Người thuê</th>
								<th>Số điện thoại</th>
								<th>Thời hạn hợp đồng</th>
								<th>Giá thuê</th>
								<th>Trạng thái</th>
								<th>Hành động</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="booking : ${activeBookings}">
								<td>
									<div class="d-flex align-items-center">
										<div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
											style="width: 32px; height: 32px;">
											[[${#strings.substring(booking.user.name, 0, 1)}]]
										</div>
										<div>
											<div class="fw-bold">[[${booking.user.name}]]</div>
											<small class="text-muted">[[${booking.user.email}]]</small>
										</div>
									</div>
								</td>
								<td>[[${booking.user.mobileNumber}]]</td>
								<td>
									<div><small class="text-muted">Từ:</small>
										[[${#temporals.format(booking.startDate, 'dd/MM/yyyy')}]]</div>
									<div><small class="text-muted">Đến:</small>
										<strong>[[${#temporals.format(booking.endDate, 'dd/MM/yyyy')}]]</strong>
									</div>
								</td>
								<td>[[${#numbers.formatDecimal(booking.monthlyRent, 0, 'COMMA', 0, 'POINT')}]] đ
								</td>
								<td><span class="badge bg-success">Đang thuê</span></td>
								<td>
									<div class="btn-group">
										<button type="button" class="btn btn-sm btn-outline-primary"
											data-bs-toggle="modal"
											th:data-bs-target="'#editBookingModal' + ${booking.id}">
											<i class="fas fa-calendar-alt"></i> Gia hạn/Sửa
										</button>
										<button type="button" class="btn btn-sm btn-outline-danger"
											data-bs-toggle="modal"
											th:data-bs-target="'#terminateModal' + ${booking.id}">
											<i class="fas fa-user-times"></i> Xóa
										</button>
									</div>
									<!-- Edit Booking Modal -->
									<div class="modal fade" th:id="'editBookingModal' + ${booking.id}" tabindex="-1">
										<div class="modal-dialog">
											<div class="modal-content">
												<form th:action="@{/admin/update-booking-dates}" method="post">
													<div class="modal-header bg-primary text-white">
														<h5 class="modal-title">Cập nhật thời hạn hợp đồng</h5>
														<button type="button" class="btn-close btn-close-white"
															data-bs-dismiss="modal"></button>
													</div>
													<div class="modal-body">
														<input type="hidden" name="bookingId" th:value="${booking.id}">
														<div class="mb-3">
															<label class="form-label">Người thuê</label>
															<input type="text" class="form-control"
																th:value="${booking.user.name}" readonly>
														</div>
														<div class="row">
															<div class="col-6">
																<div class="mb-3">
																	<label class="form-label">Ngày bắt
																		đầu</label>
																	<input type="date" name="startDate"
																		class="form-control"
																		th:value="${booking.startDate}" required>
																</div>
															</div>
															<div class="col-6">
																<div class="mb-3">
																	<label class="form-label">Ngày kết
																		thúc</label>
																	<input type="date" name="endDate"
																		class="form-control"
																		th:value="${booking.endDate}" required>
																</div>
															</div>
														</div>
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-secondary"
															data-bs-dismiss="modal">Hủy</button>
														<button type="submit" class="btn btn-primary">Lưu thay
															đổi</button>
													</div>
												</form>
											</div>
										</div>
									</div>
									<!-- Terminate Modal -->
									<div class="modal fade" th:id="'terminateModal' + ${booking.id}" tabindex="-1">
										<div class="modal-dialog">
											<div class="modal-content">
												<form th:action="@{/admin/cancel-rent}" method="post">
													<div class="modal-header bg-danger text-white">
														<h5 class="modal-title">Xác nhận xóa người thuê</h5>
														<button type="button" class="btn-close btn-close-white"
															data-bs-dismiss="modal"></button>
													</div>
													<div class="modal-body">
														<input type="hidden" name="bookingId" th:value="${booking.id}">
														<p>Bạn có chắc chắn muốn chấm dứt hợp đồng với
															<strong>[[${booking.user.name}]]</strong>?
														</p>
														<div class="alert alert-warning">
															<i class="fas fa-exclamation-triangle"></i> Hành
															động này sẽ kết thúc hợp đồng và chuyển phòng về
															trạng thái "Còn trống".
														</div>
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-secondary"
															data-bs-dismiss="modal">Hủy</button>
														<button type="submit" class="btn btn-danger">Xác nhận
															xóa</button>
													</div>
												</form>
											</div>
										</div>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Leaflet CSS & JS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
			integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
			integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

		<script th:inline="javascript">
			document.addEventListener('DOMContentLoaded', function () {
				// Get existing coordinates or default to Hanoi
				var existingLat = /*[[${room.latitude}]]*/ null;
				var existingLng = /*[[${room.longitude}]]*/ null;

				var defaultLat = existingLat ? parseFloat(existingLat) : 21.028511;
				var defaultLng = existingLng ? parseFloat(existingLng) : 105.804817;

				// If coordinates are invalid (e.g. 0 or null), fallback to default
				if (!defaultLat || !defaultLng) {
					defaultLat = 21.028511;
					defaultLng = 105.804817;
				}

				var map = L.map('map').setView([defaultLat, defaultLng], 13);

				L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
					maxZoom: 19,
					attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
				}).addTo(map);

				var marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

				// Update inputs when marker is dragged
				marker.on('dragend', function (event) {
					var position = marker.getLatLng();
					updateInputs(position.lat, position.lng);
				});

				// Move marker on map click
				map.on('click', function (e) {
					marker.setLatLng(e.latlng);
					updateInputs(e.latlng.lat, e.latlng.lng);
				});

				function updateInputs(lat, lng) {
					document.getElementById('latitude').value = lat.toFixed(6);
					document.getElementById('longitude').value = lng.toFixed(6);
				}

				// Search address function
				document.getElementById('btnSearchMap').addEventListener('click', function () {
					var address = document.querySelector('input[name="address"]').value;
					var city = document.querySelector('select[name="city"]').value;

					if (!address || !city) {
						alert('Vui lòng nhập địa chỉ và chọn thành phố trước khi tìm kiếm.');
						return;
					}

					var query = address + ', ' + city;
					var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query);

					fetch(url)
						.then(response => response.json())
						.then(data => {
							if (data && data.length > 0) {
								var lat = parseFloat(data[0].lat);
								var lon = parseFloat(data[0].lon);

								map.setView([lat, lon], 16);
								marker.setLatLng([lat, lon]);
								updateInputs(lat, lon);
							} else {
								alert('Không tìm thấy địa điểm. Vui lòng kiểm tra lại địa chỉ hoặc chọn thủ công trên bản đồ.');
							}
						})
						.catch(error => {
							console.error('Error:', error);
							alert('Có lỗi xảy ra khi tìm kiếm địa điểm.');
						});
				});
			});
		</script>
	</section>
</body>

</html>