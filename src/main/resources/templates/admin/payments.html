<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/admin_base::adminLayout(~{::section})}">

<head>
    <meta charset="UTF-8">
    <title>Quản lý thanh toán</title>
</head>

<body>
    <section th:with="currentPage='payments'">
        <div class="page-header">
            <h2><i class="fas fa-file-invoice-dollar"></i> Quản lý thanh toán hàng tháng</h2>
            <div class="mt-2">
                <a th:href="@{/admin/payment/create-new}" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i> Tạo hóa đơn mới
                </a>
            </div>
        </div>

        <th:block th:if="${session.succMsg}">
            <div class="alert alert-success alert-dismissible fade show">
                [[${session.succMsg}]]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <th:block th:if="${session.errorMsg}">
            <div class="alert alert-danger alert-dismissible fade show">
                [[${session.errorMsg}]]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
        </th:block>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Chờ thanh toán</h5>
                        <h2 class="card-text" th:text="${pendingCount}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Quá hạn</h5>
                        <h2 class="card-text" th:text="${overdueCount}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Đã thanh toán</h5>
                        <h2 class="card-text" th:text="${paidCount}">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Tổng đã thu</h5>
                        <h2 class="card-text"
                            th:text="${#numbers.formatDecimal(totalReceived, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0 VNĐ
                        </h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter buttons -->
        <div class="mb-3">
            <a th:href="@{/admin/payments}" class="btn btn-outline-primary"
                th:classappend="${currentStatus == null ? 'active' : ''}">Tất cả</a>
            <a th:href="@{/admin/payments(status='PENDING')}" class="btn btn-outline-warning"
                th:classappend="${currentStatus == 'PENDING' ? 'active' : ''}">Chờ thanh toán</a>
            <a th:href="@{/admin/payments(status='OVERDUE')}" class="btn btn-outline-danger"
                th:classappend="${currentStatus == 'OVERDUE' ? 'active' : ''}">Quá hạn</a>
            <a th:href="@{/admin/payments(status='PAID')}" class="btn btn-outline-success"
                th:classappend="${currentStatus == 'PAID' ? 'active' : ''}">Đã thanh toán</a>
        </div>

        <!-- Payments Table -->
        <div class="card">
            <div class="card-body">
                <div th:if="${payments == null || payments.isEmpty()}" class="text-center py-5">
                    <i class="fas fa-inbox fa-5x text-muted mb-3"></i>
                    <h5 class="text-muted">Chưa có thanh toán nào</h5>
                </div>

                <div th:if="${payments != null && !payments.isEmpty()}" class="table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Tháng/Năm</th>
                                <th>Phòng</th>
                                <th>Người thuê</th>
                                <th>Số tiền</th>
                                <th>Đã trả</th>
                                <th>Ngày đến hạn</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="payment : ${payments}">
                                <td th:text="${payment.month} + '/' + ${payment.year}">1/2024</td>
                                <td>
                                    <strong th:text="${payment.roomBooking?.room?.roomName}">Phòng A101</strong><br>
                                    <small class="text-muted" th:text="${payment.roomBooking?.room?.address}">Địa
                                        chỉ</small>
                                </td>
                                <td th:text="${payment.roomBooking?.user?.name}">Nguyễn Văn A</td>
                                <td class="text-end">
                                    <strong class="text-primary"
                                        th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 0, 'POINT')}">5,000,000</strong>
                                    VNĐ
                                </td>
                                <td class="text-end">
                                    <span
                                        th:text="${#numbers.formatDecimal(payment.paidAmount ?: 0, 0, 'COMMA', 0, 'POINT')}">0</span>
                                    VNĐ
                                </td>
                                <td th:text="${#temporals.format(payment.dueDate, 'dd/MM/yyyy')}">01/01/2024</td>
                                <td>
                                    <span th:if="${payment.status == 'PAID'}" class="badge bg-success">
                                        <i class="fas fa-check"></i> Đã thanh toán
                                    </span>
                                    <span th:if="${payment.status == 'PENDING'}" class="badge bg-warning">
                                        <i class="fas fa-clock"></i> Chờ thanh toán
                                    </span>
                                    <span th:if="${payment.status == 'OVERDUE'}" class="badge bg-danger">
                                        <i class="fas fa-exclamation-triangle"></i> Quá hạn
                                    </span>
                                    <span th:if="${payment.status == 'PARTIAL'}" class="badge bg-info">
                                        <i class="fas fa-info-circle"></i> Trả một phần
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a th:href="@{'/admin/payment/' + ${payment.id} + '/details'}"
                                            class="btn btn-primary btn-sm" title="Chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a th:if="${payment.status != 'PAID'}"
                                            th:href="@{'/admin/payment/' + ${payment.id} + '/record'}"
                                            class="btn btn-success btn-sm" title="Ghi nhận thanh toán">
                                            <i class="fas fa-check"></i>
                                        </a>
                                        <a th:href="@{'/admin/payment/' + ${payment.id} + '/send-reminder'}"
                                            class="btn btn-warning btn-sm" title="Gửi nhắc nhở">
                                            <i class="fas fa-bell"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div th:if="${payments != null && !payments.isEmpty()}" class="mt-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0">
                            <strong>Tổng số thanh toán:</strong>
                            <span class="badge bg-primary" th:text="${payments.size()}">0</span>
                        </p>
                        <p class="mb-0">
                            <strong>Tổng tiền chờ thu:</strong>
                            <span class="text-warning"
                                th:text="${#numbers.formatDecimal(totalExpected, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0
                                VNĐ</span>
                        </p>
                        <p class="mb-0">
                            <strong>Tổng đã thu:</strong>
                            <span class="text-success"
                                th:text="${#numbers.formatDecimal(totalReceived, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">0
                                VNĐ</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>

</html>