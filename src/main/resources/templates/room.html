<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Danh sách phòng trọ</title>
</head>
<body>
	<section>
		<!-- Search Bar -->

		<div class="container-fluid bg-primary p-4 mt-5">
			<div class="row">
				<div class="col-md-8 offset-md-2">
					<form action="/rooms" method="get">
						<div class="input-group">
							<input type="text" class="form-control" name="ch" placeholder="Tìm kiếm phòng trọ theo tên, địa chỉ...">
							<button class="btn btn-light text-dark ms-3 col-md-2">
								<i class="fa-solid fa-magnifying-glass"></i> Tìm kiếm
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Main Content -->
		<div class="container-fluid mt-1">
			<div class="row">
				<!-- Room List - Full Width -->
				<div class="col-md-12">
					<div class="card">
						<div class="card-body">
							<!-- Filter Bar -->
							<div class="mb-4 p-3 bg-light rounded">
								<form action="/rooms" method="get" id="filterForm">
									<div class="row g-3 align-items-end">
										<!-- Loại trọ -->
										<div class="col-md-2">
											<label class="form-label fw-bold"><i class="fas fa-home text-info"></i> Loại trọ</label>
											<select class="form-select" name="roomType" id="roomTypeSelect">
												<option value="" th:selected="${paramValue == ''}">Tất cả</option>
												<option th:each="rt : ${roomTypes}"
														th:value="${rt.name}"
														th:text="${rt.name}"
														th:selected="${rt.name == paramValue}"></option>
											</select>
										</div>

										<!-- Khu vực -->
										<div class="col-md-2">
											<label class="form-label fw-bold"><i class="fas fa-map-marker-alt text-danger"></i> Khu vực</label>
											<select class="form-select" name="city" id="citySelect">
												<option value="">Tất cả khu vực</option>
												<option value="Hà Nội" th:selected="${selectedCity == 'Hà Nội'}">Hà Nội</option>
												<option value="Hải Phòng" th:selected="${selectedCity == 'Hải Phòng'}">Hải Phòng</option>
												<option value="Thái Nguyên" th:selected="${selectedCity == 'Thái Nguyên'}">Thái Nguyên</option>
												<option value="Quảng Ninh" th:selected="${selectedCity == 'Quảng Ninh'}">Quảng Ninh</option>
												<option value="Nam Định" th:selected="${selectedCity == 'Nam Định'}">Nam Định</option>
												<option value="Ninh Bình" th:selected="${selectedCity == 'Ninh Bình'}">Ninh Bình</option>
											</select>
										</div>

										<!-- Khoảng giá -->
										<div class="col-md-3">
											<label class="form-label fw-bold"><i class="fas fa-dollar-sign text-success"></i> Khoảng giá</label>
											<select class="form-select" id="priceRangeSelect" onchange="updatePriceRange()">
												<option value="">Tất cả mức giá</option>
												<option value="0-2000000" th:selected="${minPrice == 0 && maxPrice == 2000000}">Dưới 2 triệu</option>
												<option value="2000000-5000000" th:selected="${minPrice == 2000000 && maxPrice == 5000000}">2 - 5 triệu</option>
												<option value="5000000-10000000" th:selected="${minPrice == 5000000 && maxPrice == 10000000}">5 - 10 triệu</option>
												<option value="10000000-999999999" th:selected="${minPrice == 10000000}">Trên 10 triệu</option>
											</select>
											<input type="hidden" name="minPrice" id="minPrice" th:value="${minPrice}">
											<input type="hidden" name="maxPrice" id="maxPrice" th:value="${maxPrice}">
										</div>

										<!-- Sắp xếp giá -->
										<div class="col-md-3">
											<label class="form-label fw-bold"><i class="fas fa-sort text-primary"></i> Sắp xếp</label>
											<select class="form-select" name="sortBy" id="sortBySelect">
												<option value="">Mặc định</option>
												<option value="newest" th:selected="${sortBy == 'newest'}">Mới nhất</option>
												<option value="priceLowToHigh" th:selected="${sortBy == 'priceLowToHigh'}">Giá: Thấp → Cao</option>
												<option value="priceHighToLow" th:selected="${sortBy == 'priceHighToLow'}">Giá: Cao → Thấp</option>
											</select>
										</div>

										<!-- Nút lọc -->
										<div class="col-md-2">
											<button type="submit" class="btn btn-primary w-100">
												<i class="fas fa-filter"></i> Áp dụng
											</button>
											<a th:href="@{/rooms}" class="btn btn-outline-secondary w-100 mt-2">
												<i class="fas fa-redo"></i> Xóa lọc
											</a>
										</div>
									</div>
								</form>
							</div>

							<!-- Room count -->
							<div class="d-flex justify-content-between align-items-center mb-3">
								<p class="fs-5 mb-0 text-muted">
									<i class="fas fa-home"></i> Tìm thấy <strong>[[${totalElements}]]</strong> phòng trọ
								</p>
							</div>

							<div class="row">
								<th:block th:if="${roomsSize >0}">
									<div class="col-md-4 mt-3" th:each="room:${rooms}">
										<div class="card card-sh h-100">
											<img alt="Ảnh phòng trọ" th:src="@{'/img/room_img/'+${room.image}}"
												class="card-img-top"
												style="width: 100%; height: 200px; object-fit: cover; display: block;">
											<div class="card-body d-flex flex-column">
												<h5 class="card-title">[[${room.roomName}]]</h5>
												<p class="card-text text-muted">
													<i class="fas fa-map-marker-alt text-danger"></i>
													[[${room.address}]], [[${room.district}]], [[${room.city}]]
												</p>

												<div class="mb-2">
													<small class="text-muted">[[${room.roomType}]] • [[${room.area}]] m² • Tối đa [[${room.maxOccupants}]] người</small>
												</div>

												<div class="mb-2">
													<span class="badge bg-primary me-1" th:if="${room.hasWifi}">WiFi</span>
													<span class="badge bg-info me-1" th:if="${room.hasAirConditioner}">Điều hòa</span>
													<span class="badge bg-success me-1" th:if="${room.hasParking}">Parking</span>
													<span class="badge bg-warning" th:if="${room.allowPets}">Cho phép pet</span>
												</div>

												<div class="mt-auto">
													<div class="d-flex justify-content-between align-items-center mb-2">
														<span class="text-success fw-bold fs-5">
															[[${#numbers.formatDecimal(room.monthlyRent, 0, 'COMMA', 0, 'POINT')}]] VNĐ/tháng
														</span>
														<span class="badge bg-secondary" th:if="${room.isAvailable}" th:text="'Còn trống'"></span>
														<span class="badge bg-danger" th:unless="${room.isAvailable}" th:text="'Đã thuê'"></span>
													</div>
													<a th:href="@{'/room/'+${room.id}}" class="btn btn-primary w-100">
														Xem chi tiết
													</a>
												</div>
											</div>
										</div>
									</div>
								</th:block>

								<th:block th:unless="${roomsSize>0}">
									<div class="col-12">
										<div class="text-center mt-5">
											<i class="fas fa-home fa-5x text-muted mb-3"></i>
											<p class="fs-4 text-danger">Không tìm thấy phòng trọ phù hợp</p>
											<p class="text-muted">Hãy thử tìm kiếm với từ khóa khác hoặc xem tất cả phòng trọ</p>
											<a href="/rooms" class="btn btn-primary">Xem tất cả phòng trọ</a>
										</div>
									</div>
								</th:block>
							</div>
						</div>
					</div>

					<!-- Pagination -->
					<div class="row mt-3" th:if="${roomsSize>0}">
						<div class="col-md-4">
							<p class="text-muted">Tổng số phòng: [[${totalElements}]]</p>
						</div>
						<div class="col-md-8">
							<nav aria-label="Phân trang">
								<ul class="pagination justify-content-center">
									<li class="page-item" th:classappend="${isFirst} ? 'disabled':''">
										<a class="page-link"
										   th:href="@{'/rooms?pageNo='+${pageNo-1}+'&roomType='+${paramValue}+'&sortBy='+${sortBy}}"
										   aria-label="Previous">
											<span aria-hidden="true">&laquo;</span>
										</a>
									</li>

									<li th:each="i:${#numbers.sequence(1,totalPages)}" class="page-item"
										th:classappend="${pageNo+1==i}?'active':''">
										<a class="page-link"
										   th:href="@{'/rooms?pageNo='+${i-1}+'&roomType='+${paramValue}+'&sortBy='+${sortBy}}">[[${i}]]</a>
									</li>

									<li class="page-item" th:classappend="${isLast} ? 'disabled':''">
										<a class="page-link"
										   th:href="@{'/rooms?pageNo='+${pageNo+1}+'&roomType='+${paramValue}+'&sortBy='+${sortBy}}"
										   aria-label="Next">
											<span aria-hidden="true">&raquo;</span>
										</a>
									</li>
								</ul>
							</nav>
						</div>
					</div>
				</div>
			</div>
		</div>

	</section>

	<script>
		function applySorting() {
			var sortBy = document.getElementById('sortSelect').value;
			var url = new URL(window.location.href);

			// Giữ các tham số hiện tại
			var roomType = url.searchParams.get('roomType') || '';
			var ch = url.searchParams.get('ch') || '';

			// Tạo URL mới với sort
			var newUrl = '/rooms?';
			if (roomType) newUrl += 'roomType=' + encodeURIComponent(roomType) + '&';
			if (ch) newUrl += 'ch=' + encodeURIComponent(ch) + '&';
			if (sortBy) newUrl += 'sortBy=' + encodeURIComponent(sortBy);

			// Redirect đến URL mới
			window.location.href = newUrl;
		}

		function updatePriceRange() {
			var priceRange = document.getElementById('priceRangeSelect').value;
			var minPrice = document.getElementById('minPrice');
			var maxPrice = document.getElementById('maxPrice');

			if (priceRange) {
				var prices = priceRange.split('-');
				minPrice.value = prices[0];
				maxPrice.value = prices[1];
			} else {
				minPrice.value = '';
				maxPrice.value = '';
			}
		}
	</script>
</body>
</html>