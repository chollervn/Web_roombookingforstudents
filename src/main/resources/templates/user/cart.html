<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{base::layout(~{::section})}">
<head>
<meta charset="UTF-8">
<title>Trọ đã xem - Phòng trọ</title>
</head>
<body>
	<section style="padding-top: 90px; min-height: 100vh;">
		<div class="container mt-3 p-3">
			<div class="card border">
				<div class="card-header bg-light text-center">
					<h4 class="mb-2">Trọ đã xem</h4>
					<th:block th:if="${session.succMsg}">
						<div class="alert alert-success">[[${session.succMsg}]]</div>
						<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
					</th:block>

					<th:block th:if="${session.errorMsg}">
						<div class="alert alert-danger">[[${session.errorMsg}]]</div>
						<th:block th:text="${@commnServiceImpl.removeSessionMessage()}"></th:block>
					</th:block>
				</div>
				<div class="card-body">
					<div th:if="${carts != null and !carts.isEmpty()}">
						<table class="table table-bordered" style="table-layout: fixed;">
							<thead class="bg-dark text-white">
								<tr>
									<th width="5%">STT</th>
									<th width="12%">Hình</th>
									<th width="28%">Thông Tin Phòng</th>
									<th width="12%">Giá Thuê</th>
									<th width="15%">Trạng Thái Cọc</th>
									<th width="18%">Thao Tác</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="cart,c:${carts}">
									<td class="text-center align-middle">[[${c.count}]]</td>
									<td class="align-middle text-center">
										<div style="width: 80px; height: 60px; margin: 0 auto; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border-radius: 5px; overflow: hidden;">
											<img th:src="@{'/img/room_img/'+${cart.room.image}}"
												 style="width: 100%; height: 100%; object-fit: cover; display: block; border: none; outline: none;"
												 th:alt="${cart.room.roomName}"
												 loading="eager"
												 onload="this.style.opacity='1'"
												 onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'color:#999;font-size:12px;\'>No Image</div>'"
												 decoding="sync">
										</div>
									</td>
									<td class="align-middle">
										<div>
											<strong>[[${cart.room.roomName}]]</strong><br>
											<small class="text-muted">[[${cart.room.roomType}]]</small><br>
											<small>[[${cart.room.address}]]</small><br>
											<small class="text-muted">[[${cart.room.district}]], [[${cart.room.city}]]</small>
										</div>
									</td>
									<td class="align-middle">
										<strong>[[${#numbers.formatDecimal(cart.room.monthlyRent, 0, 'COMMA', 0, 'POINT')}]] VNĐ</strong><br>
										<small class="text-muted">/tháng</small>
									</td>
									<td class="align-middle text-center">
										<!-- Hiển thị trạng thái đặt cọc -->
										<th:block th:with="deposit=${depositMap[cart.room.id]}">
											<span th:if="${deposit != null && deposit.status == 'APPROVED'}" class="badge bg-success">
												<i class="fas fa-check-circle"></i> Đã duyệt
											</span>
											<span th:if="${deposit != null && deposit.status == 'PENDING'}" class="badge bg-warning text-dark">
												<i class="fas fa-clock"></i> Chờ duyệt
											</span>
											<span th:if="${deposit != null && deposit.status == 'REJECTED'}" class="badge bg-danger">
												<i class="fas fa-times-circle"></i> Bị từ chối
											</span>
											<span th:if="${deposit == null}" class="badge bg-secondary">
												<i class="fas fa-info-circle"></i> Chưa đặt cọc
											</span>
										</th:block>
									</td>
									<td class="text-center align-middle">
										<!-- Kiểm tra trạng thái cọc để hiển thị nút phù hợp -->
										<th:block th:with="deposit=${depositMap[cart.room.id]}">
											<!-- Nếu chưa đặt cọc hoặc bị từ chối => cho phép đặt cọc và xóa -->
											<div th:if="${deposit == null || deposit.status == 'REJECTED'}">
												<a th:href="@{'/user/chat?rid='+${cart.room.id}}" class="btn btn-primary btn-sm mb-1">
													<i class="fas fa-comments"></i> Chat
												</a>
												<a th:href="@{'/user/deposit?rid='+${cart.room.id}}" class="btn btn-warning btn-sm mb-1">
													<i class="fas fa-money-bill-wave"></i> Đặt cọc
												</a>
												<a th:href="@{'/user/deleteCart?cid='+${cart.id}}"
												   class="btn btn-danger btn-sm"
												   onclick="return confirm('Bạn có chắc muốn xóa trọ này khỏi danh sách?')">
													<i class="fas fa-trash"></i> Xóa
												</a>
											</div>

											<!-- Nếu đã đặt cọc (pending hoặc approved) => chỉ cho chat, không cho xóa -->
											<div th:if="${deposit != null && (deposit.status == 'PENDING' || deposit.status == 'APPROVED')}">
												<a th:href="@{'/user/chat?rid='+${cart.room.id}}" class="btn btn-primary btn-sm mb-1">
													<i class="fas fa-comments"></i> Chat với Chủ trọ
												</a>
												<span th:if="${deposit.status == 'PENDING'}" class="text-muted small d-block">
													Đang chờ xác nhận
												</span>
												<span th:if="${deposit.status == 'APPROVED'}" class="text-success small d-block">
													<i class="fas fa-check"></i> Đã được duyệt
												</span>
											</div>
										</th:block>
									</td>
								</tr>
							</tbody>
						</table>
						<div class="text-center mt-4">
							<a href="/" class="btn btn-secondary">Tiếp tục xem phòng</a>
						</div>
					</div>

					<div th:if="${carts == null or carts.isEmpty()}" class="text-center py-5">
						<h4>Chưa có Trọ đã xem</h4>
						<p>Chưa có phòng nào trong danh sách Trọ đã xem</p>
						<a href="/" class="btn btn-primary">Xem phòng ngay</a>
					</div>
				</div>
			</div>
		</div>

		<!-- Add CSS to prevent flickering -->
		<style>
			/* Prevent image flickering */
			img {
				image-rendering: -webkit-optimize-contrast;
				image-rendering: crisp-edges;
				backface-visibility: hidden;
				transform: translateZ(0);
			}

			/* Stabilize table layout */
			.table {
				table-layout: fixed !important;
			}

			/* Remove all hover effects that might cause flickering */
			.table tr:hover {
				background-color: inherit !important;
			}

			/* Prevent any animations */
			* {
				animation: none !important;
				transition: none !important;
			}
		</style>
	</section>
</body>
</html>