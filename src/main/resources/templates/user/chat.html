<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{base::layout(~{::section})}">

<head>
	<meta charset="UTF-8">
	<title>Tin nhắn</title>
</head>

<body>
	<section>
		<style>
			.chat-container {
				display: flex;
				height: 600px;
				background: white;
				border-radius: 12px;
				overflow: hidden;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
				margin-top: 20px;
				margin-bottom: 40px;
			}

			.chat-sidebar {
				width: 300px;
				border-right: 1px solid #eee;
				display: flex;
				flex-direction: column;
			}

			.chat-list {
				flex: 1;
				overflow-y: auto;
			}

			.chat-item {
				padding: 15px;
				display: flex;
				align-items: center;
				cursor: pointer;
				transition: background 0.2s;
				border-bottom: 1px solid #f5f5f5;
			}

			.chat-item:hover,
			.chat-item.active {
				background: #f8f9fa;
			}

			.chat-item.active {
				border-left: 3px solid #2196F3;
			}

			.room-avatar {
				width: 45px;
				height: 45px;
				background: #e3f2fd;
				color: #2196F3;
				border-radius: 10px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 20px;
				margin-right: 12px;
			}

			.chat-info {
				flex: 1;
			}

			.chat-name {
				font-weight: 600;
				color: #2c3e50;
				margin-bottom: 3px;
			}

			.chat-main {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: #fdfdfd;
			}

			.chat-header {
				padding: 15px 20px;
				background: white;
				border-bottom: 1px solid #eee;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.chat-messages {
				flex: 1;
				padding: 20px;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
				gap: 15px;
			}

			.message {
				max-width: 70%;
				padding: 10px 15px;
				border-radius: 15px;
				position: relative;
				font-size: 14px;
				line-height: 1.4;
			}

			.message.received {
				align-self: flex-start;
				background: white;
				border: 1px solid #eee;
				border-bottom-left-radius: 5px;
			}

			.message.sent {
				align-self: flex-end;
				background: #2196F3;
				color: white;
				border-bottom-right-radius: 5px;
			}

			.message-time {
				font-size: 10px;
				margin-top: 5px;
				opacity: 0.7;
				text-align: right;
			}

			.chat-input-area {
				padding: 20px;
				background: white;
				border-top: 1px solid #eee;
				display: flex;
				gap: 10px;
			}

			.chat-input {
				flex: 1;
				border: 1px solid #ddd;
				border-radius: 25px;
				padding: 10px 20px;
				outline: none;
				transition: border-color 0.2s;
			}

			.chat-input:focus {
				border-color: #2196F3;
			}

			.btn-send {
				width: 45px;
				height: 45px;
				border-radius: 50%;
				background: #2196F3;
				color: white;
				border: none;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				transition: transform 0.2s;
			}

			.btn-send:hover {
				transform: scale(1.05);
			}
		</style>

		<div class="container">
			<div class="chat-container">
				<!-- Sidebar -->
				<div class="chat-sidebar">
					<div class="p-3 border-bottom">
						<h5 class="mb-0">Tin nhắn</h5>
					</div>
					<div class="chat-list">
						<div th:each="room : ${conversationRooms}" class="chat-item"
							th:onclick="'loadChat(' + ${room.id} + ', \'' + ${room.roomName} + '\', ' + ${room.ownerId} + ')'"
							th:id="'room-' + ${room.id}">
							<div class="room-avatar">
								<i class="fas fa-home"></i>
							</div>
							<div class="chat-info">
								<div class="chat-name" th:text="${room.roomName}">Phòng 101</div>
								<small class="text-muted">Chat với chủ trọ</small>
							</div>
						</div>
					</div>
				</div>

				<!-- Main Chat Area -->
				<div class="chat-main">
					<div id="chatHeader" class="chat-header" style="display: none;">
						<div class="d-flex align-items-center">
							<div class="room-avatar me-3" style="width: 40px; height: 40px; font-size: 16px;">
								<i class="fas fa-user-tie"></i>
							</div>
							<div>
								<h6 class="mb-0" id="currentRoomName">Phòng 101</h6>
								<small class="text-success">Chủ trọ</small>
							</div>
						</div>
					</div>

					<div id="chatMessages" class="chat-messages">
						<div class="h-100 d-flex align-items-center justify-content-center text-muted">
							<div>
								<i class="far fa-comments fa-3x mb-3"></i>
								<p>Chọn một phòng để chat với chủ trọ</p>
							</div>
						</div>
					</div>

					<div id="chatInputArea" class="chat-input-area" style="display: none;">
						<input type="text" id="messageInput" class="chat-input" placeholder="Nhập tin nhắn...">
						<button class="btn-send" onclick="sendMessage()">
							<i class="fas fa-paper-plane"></i>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- WebSocket Libraries -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

		<script th:inline="javascript">
			let stompClient = null;
			let currentRoomId = null;
			let currentReceiverId = null;
			const currentUserId = [[${ #authentication.principal.user.id }]];

			function connect() {
				const socket = new SockJS('/ws');
				stompClient = Stomp.over(socket);
				stompClient.connect({}, function (frame) {
					console.log('Connected: ' + frame);

					stompClient.subscribe('/user/queue/messages', function (messageOutput) {
						const message = JSON.parse(messageOutput.body);
						if (message.room.id === currentRoomId) {
							showMessage(message);
						}
					});
				});
			}

			function loadChat(roomId, roomName, ownerId) {
				currentRoomId = roomId;
				currentReceiverId = ownerId; // For user, receiver is always the owner

				document.getElementById('currentRoomName').innerText = roomName;
				document.getElementById('chatHeader').style.display = 'flex';
				document.getElementById('chatInputArea').style.display = 'flex';

				document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
				document.getElementById('room-' + roomId).classList.add('active');

				fetch('/chat/history/' + roomId)
					.then(response => response.json())
					.then(messages => {
						const chatMessages = document.getElementById('chatMessages');
						chatMessages.innerHTML = '';

						if (messages.length > 0) {
							messages.forEach(msg => showMessage(msg));
							scrollToBottom();
						} else {
							chatMessages.innerHTML = '<div class="text-center text-muted mt-5">Bắt đầu cuộc trò chuyện với chủ trọ</div>';
						}
					});
			}

			function sendMessage() {
				const messageInput = document.getElementById('messageInput');
				const content = messageInput.value.trim();

				if (content && stompClient && currentRoomId) {
					const chatMessage = {
						message: content,
						room: { id: currentRoomId },
						receiver: { id: currentReceiverId }
					};

					stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));

					const myMessage = {
						message: content,
						sender: { id: currentUserId },
						timestamp: new Date().toISOString()
					};
					showMessage(myMessage);

					messageInput.value = '';
					scrollToBottom();
				}
			}

			function showMessage(message) {
				const chatMessages = document.getElementById('chatMessages');
				const isMe = message.sender.id === currentUserId;

				const div = document.createElement('div');
				div.className = `message ${isMe ? 'sent' : 'received'}`;

				const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

				div.innerHTML = `
                ${message.message}
                <div class="message-time">${time}</div>
            `;

				chatMessages.appendChild(div);
				scrollToBottom();
			}

			function scrollToBottom() {
				const chatMessages = document.getElementById('chatMessages');
				chatMessages.scrollTop = chatMessages.scrollHeight;
			}

			document.getElementById('messageInput').addEventListener('keypress', function (e) {
				if (e.key === 'Enter') {
					sendMessage();
				}
			});

			connect();
		</script>
	</section>
</body>

</html>
